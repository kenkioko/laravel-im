@extends('layouts.app')

@section('content')
<div class="container">
    @if ($errors->any())
        <div class="alert alert-danger">
            <strong> Errors Occured </strong>
            <ul>
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
        </div>
    @endif

    @if (session('success'))
        <div class="alert alert-success">
            <strong> {{ session('success') }} </strong>
        </div>
    @endif

    <form method="post" action="{{ route('messages.store') }}">
        @csrf

        <div class="form-group">
            <label for="messageTextArea">Type your message</label>
            <textarea class="form-control @error('message') is-invalid @enderror" id="messageTextArea" rows="10" name="message"></textarea>

            @error('message')
                <span class="invalid-feedback" role="alert">
                    <strong>{{ $message }}</strong>
                </span>
            @enderror
        </div>

        <div class="form-group">
            <label for="receiverSelect">Select user to send message</label>
            <select class="form-control @error('receiver') is-invalid @enderror"" id="receiverSelect" name="receiver">
                <option>Choose Receiver...</option>

                @foreach ($users as $user)
                    @if ($user != Auth::user())
                        <option value="{{ $user->id }}">{{ $user->name }}</option>
                    @endif
                @endforeach
            </select>

            @error('receiver')
                <span class="invalid-feedback" role="alert">
                    <strong>{{ $message }}</strong>
                </span>
            @enderror
          </div>

        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
</div>

<!-- Listener for Event Broadcasts -->
<script src="{{ asset('js/bootstrap.js') }}"></script>
<script type="text/javascript">
    Echo.channel(`instant-messaging.{{ Auth::user()->id }}`)
        .listen('.instant-messaging', (e) => {
            console.log(e.update, 'what!');
        });
</script>

@endsection
